<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href='https://fonts.googleapis.com/css?family=Nunito' rel='stylesheet'>
    <link rel="stylesheet" href="style.css">
</head>
<script src="/socket.io/socket.io.js"></script>
<body>
    <div class="chat"> 
        <ul id="messages"></ul>
            <form id="form" action="">
                <input id="textbox" autocomplete="off" /><button id="send">Send</button>
            </form>
    </div>
<script>
    var socket = io();
    
    var form = document.getElementById('form');
    var textbox = document.getElementById('textbox');
    var send = document.getElementById('send');

    function getCookie(name){
        let cookiearr = document.cookie.split(';');
        for(let i=0; i < cookiearr.length; i++){
            let cookiepair = cookiearr[i].split('=');
            if(name == cookiepair[0].trim()){
                return decodeURIComponent(cookiepair[1]);
            }
        }
    }
    
    const token = getCookie('token');
    const username = getCookie('username');

    if(!token || !username){
        window.location.href = '/login';
    }

    send.addEventListener('click', (e) => {
        e.preventDefault();
        if(textbox.value){
            const message = textbox.value;
            socket.emit('chat', message, username, token);
            textbox.value = '';
        }
    })
    socket.on('error', async (error) => {
        await window.alert(error);
        window.location.href = '/login';
    })
    socket.on('chat', (message, username) => {
        var item1 = document.createElement('li');
        item1.textContent = `${username}`;
        item1.setAttribute('id', 'chatuser');
        document.getElementById('messages').appendChild(item1);
        var item2 = document.createElement('li');   
        item2.textContent = `${message}`;
        item2.setAttribute('id', 'chatmessage');
        document.getElementById('messages').appendChild(item2);
    }); 
</script>
</body>
</html>